<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation de salles - Université Eiffel</title>
    <link rel="stylesheet" href="../CSS/styleadmin.css">
    <link rel="stylesheet" href="../CSS/reservation_salle.css">
</head>
<body>
    <div class="container">
        <h1>Réservation de salles</h1>
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <!-- Filtres -->
        <div class="filter-section">
            <select id="capaciteFilter">
                <option value="">Toutes les capacités</option>
                <option value="10">10 personnes ou moins</option>
                <option value="20">20 personnes ou moins</option>
                <option value="30">30 personnes ou moins</option>
                <option value="50">50 personnes ou moins</option>
                <option value="100">100 personnes ou moins</option>
            </select>
        </div>

        <!-- Grille des salles -->
        <div id="sallesGrid" class="salles-grid">
            <!-- Les salles seront chargées ici dynamiquement -->
        </div>

        <!-- Mes réservations -->
        <div class="table-section">
            <h2>Mes réservations</h2>
            <table>
                <thead>
                    <tr>
                        <th>Salle</th>
                        <th>Capacité</th>
                        <th>Date début</th>
                        <th>Date fin</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody id="reservationsTableBody">
                    <!-- Les réservations seront chargées ici dynamiquement -->
                </tbody>
            </table>
        </div>

        <!-- Modal de réservation -->
        <div id="reservationModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Nouvelle réservation</h2>
                <form id="reservationForm">
                    <input type="hidden" id="salle_id" name="salle_id">
                    <div class="form-group">
                        <label for="date_debut">Date et heure de début :</label>
                        <input type="datetime-local" id="date_debut" name="date_debut" required>
                    </div>
                    <div class="form-group">
                        <label for="date_fin">Date et heure de fin :</label>
                        <input type="datetime-local" id="date_fin" name="date_fin" required>
                    </div>
                    <button type="submit">Réserver</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Charger les salles et les réservations au chargement de la page
        window.onload = function() {
            loadSalles();
            loadReservations();
        };

        // Gérer le filtre de capacité
        document.getElementById('capaciteFilter').addEventListener('change', function() {
            loadSalles();
        });

        // Charger les salles
        function loadSalles() {
            const capacite = document.getElementById('capaciteFilter').value;
            fetch(`../PHP/reservation_salle.php?action=list_salles${capacite ? '&capacite=' + capacite : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        const grid = document.getElementById('sallesGrid');
                        grid.innerHTML = '';
                        
                        data.salles.forEach(salle => {
                            const card = document.createElement('div');
                            card.className = 'salle-card';
                            card.innerHTML = `
                                ${salle.photo ? 
                                    `<img src="../${salle.photo}" alt="Photo de ${salle.nom}" class="salle-photo">` : 
                                    '<div class="no-photo">Pas de photo</div>'
                                }
                                <div class="salle-info">
                                    <h3>Salle ${salle.nom}</h3>
                                    <p>Capacité : ${salle.capacite} personnes</p>
                                    ${salle.description ? `<p>${salle.description}</p>` : ''}
                                    <button onclick="openReservationModal(${salle.id})">Réserver</button>
                                </div>
                            `;
                            grid.appendChild(card);
                        });
                    }
                })
                .catch(error => {
                    showError('Erreur lors du chargement des salles');
                });
        }

        // Charger les réservations
        function loadReservations() {
            fetch('../PHP/reservation_salle.php?action=list_reservations')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        const tbody = document.getElementById('reservationsTableBody');
                        tbody.innerHTML = '';
                        
                        data.reservations.forEach(reservation => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${reservation.salle_nom}</td>
                                <td>${reservation.capacite} personnes</td>
                                <td>${formatDate(reservation.date_debut)}</td>
                                <td>${formatDate(reservation.date_fin)}</td>
                                <td class="status-${reservation.statut}">${reservation.statut}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    showError('Erreur lors du chargement des réservations');
                });
        }

        // Ouvrir le modal de réservation
        function openReservationModal(salleId) {
            document.getElementById('salle_id').value = salleId;
            document.getElementById('reservationModal').style.display = 'block';
        }

        // Gérer le formulaire de réservation
        document.getElementById('reservationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.append('action', 'reserver');
            
            fetch('../PHP/reservation_salle.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    showSuccess(data.success);
                    document.getElementById('reservationModal').style.display = 'none';
                    this.reset();
                    loadReservations();
                }
            })
            .catch(error => {
                showError('Erreur lors de la réservation');
            });
        });

        // Fermer le modal
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('reservationModal').style.display = 'none';
        });

        window.onclick = function(event) {
            if (event.target == document.getElementById('reservationModal')) {
                document.getElementById('reservationModal').style.display = 'none';
            }
        };

        // Fonctions utilitaires
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html> 