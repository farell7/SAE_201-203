<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation de matériel - Université Eiffel</title>
    <link rel="stylesheet" href="../CSS/styleadmin.css">
    <link rel="stylesheet" href="../CSS/reservation_materiel.css">
</head>
<body>
    <div class="container">
        <h1>Réservation de matériel</h1>
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <!-- Filtres -->
        <div class="filter-section">
            <select id="typeFilter">
                <option value="">Tous les types</option>
                <option value="informatique">Informatique</option>
                <option value="audiovisuel">Audiovisuel</option>
                <option value="reseau">Réseau</option>
                <option value="autre">Autre</option>
            </select>
            <select id="etatFilter">
                <option value="">Tous les états</option>
                <option value="bon">Bon état</option>
                <option value="moyen">État moyen</option>
                <option value="mauvais">Mauvais état</option>
            </select>
        </div>

        <!-- Grille du matériel -->
        <div id="materielGrid" class="materiel-grid">
            <!-- Le matériel sera chargé ici dynamiquement -->
        </div>

        <!-- Mes réservations -->
        <div class="table-section">
            <h2>Mes réservations</h2>
            <table>
                <thead>
                    <tr>
                        <th>Matériel</th>
                        <th>Type</th>
                        <th>Date début</th>
                        <th>Date fin</th>
                        <th>Statut</th>
                        <th>Commentaire</th>
                    </tr>
                </thead>
                <tbody id="reservationsTableBody">
                    <!-- Les réservations seront chargées ici dynamiquement -->
                </tbody>
            </table>
        </div>

        <!-- Modal de réservation -->
        <div id="reservationModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Nouvelle réservation</h2>
                <form id="reservationForm">
                    <input type="hidden" id="materiel_id" name="materiel_id">
                    <div class="form-group">
                        <label for="date_debut">Date et heure de début :</label>
                        <input type="datetime-local" id="date_debut" name="date_debut" required>
                    </div>
                    <div class="form-group">
                        <label for="date_fin">Date et heure de fin :</label>
                        <input type="datetime-local" id="date_fin" name="date_fin" required>
                    </div>
                    <button type="submit">Réserver</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Charger le matériel et les réservations au chargement de la page
        window.onload = function() {
            loadMateriel();
            loadReservations();
        };

        // Gérer les filtres
        document.getElementById('typeFilter').addEventListener('change', loadMateriel);
        document.getElementById('etatFilter').addEventListener('change', loadMateriel);

        // Charger le matériel
        function loadMateriel() {
            const type = document.getElementById('typeFilter').value;
            const etat = document.getElementById('etatFilter').value;
            fetch(`../PHP/reservation_materiel.php?action=list_materiel${type ? '&type=' + type : ''}${etat ? '&etat=' + etat : ''}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        const grid = document.getElementById('materielGrid');
                        grid.innerHTML = '';
                        
                        data.materiel.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'materiel-card';
                            card.innerHTML = `
                                ${item.photo ? 
                                    `<img src="../${item.photo}" alt="Photo de ${item.nom}" class="materiel-photo">` : 
                                    '<div class="no-photo">Pas de photo</div>'
                                }
                                <div class="materiel-info">
                                    <h3>${item.nom}</h3>
                                    <p>Type : ${item.type}</p>
                                    <p>État : ${item.etat}</p>
                                    ${item.description ? `<p>${item.description}</p>` : ''}
                                    <button onclick="openReservationModal(${item.id})" ${item.disponible ? '' : 'disabled'}>
                                        ${item.disponible ? 'Réserver' : 'Indisponible'}
                                    </button>
                                </div>
                            `;
                            grid.appendChild(card);
                        });
                    }
                })
                .catch(error => {
                    showError('Erreur lors du chargement du matériel');
                });
        }

        // Charger les réservations
        function loadReservations() {
            fetch('../PHP/reservation_materiel.php?action=list_reservations')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        const tbody = document.getElementById('reservationsTableBody');
                        tbody.innerHTML = '';
                        
                        if (data.reservations.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune réservation trouvée</td></tr>';
                        } else {
                            data.reservations.forEach(reservation => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${reservation.materiel_nom}</td>
                                    <td>${reservation.materiel_type}</td>
                                    <td>${formatDate(reservation.date_debut)}</td>
                                    <td>${formatDate(reservation.date_fin)}</td>
                                    <td class="status-${reservation.statut}">${reservation.statut}</td>
                                    <td>${reservation.commentaire || '-'}</td>
                                `;
                                tbody.appendChild(tr);
                            });
                        }
                    }
                })
                .catch(error => {
                    showError('Erreur lors du chargement des réservations');
                });
        }

        // Ouvrir le modal de réservation
        function openReservationModal(materielId) {
            document.getElementById('materiel_id').value = materielId;
            document.getElementById('reservationModal').style.display = 'block';
        }

        // Gérer le formulaire de réservation
        document.getElementById('reservationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.append('action', 'reserver');
            
            fetch('../PHP/reservation_materiel.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    showSuccess(data.success);
                    document.getElementById('reservationModal').style.display = 'none';
                    this.reset();
                    loadReservations();
                }
            })
            .catch(error => {
                showError('Erreur lors de la réservation');
            });
        });

        // Fermer le modal
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('reservationModal').style.display = 'none';
        });

        window.onclick = function(event) {
            if (event.target == document.getElementById('reservationModal')) {
                document.getElementById('reservationModal').style.display = 'none';
            }
        };

        // Fonctions utilitaires
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html> 